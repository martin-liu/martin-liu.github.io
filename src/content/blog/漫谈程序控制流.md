---
author: Martin Liu
pubDatetime: 2015-07-16T19:39:22.417Z
title: æ¼«è°ˆç¨‹åºæ§åˆ¶æµ
postSlug: æ¼«è°ˆç¨‹åºæ§åˆ¶æµ
featured: false
ogImage: ""
tags:
  - chinese
  - programming
description: ES6çš„generatorå¯ä»¥ç©é­”æ³•!!ğŸ˜®ä¸è¿‡ï¼Œç¨‹åºçš„ä¸–ç•Œï¼Œå¹¶æ²¡æœ‰æ— æ ¹ä¹‹æœ¨ã€æ— æºä¹‹æ°´ã€‚è®©æˆ‘ä»¬å›æº¯æœ¬æºï¼Œæ¢ä¸€æ¢å„ç§é«˜é˜¶æµç¨‹æ§åˆ¶ç»“æ„(æ¯”å¦‚continuation, coroutine)çš„æ¥é¾™å»è„‰
---

## Table of contents

## å‰è¨€

éšç€[ECMAScript 2015](http://www.ecma-international.org/publications/standards/Ecma-262.htm)(ES6)çš„æ­£å¼å‘å¸ƒï¼Œä»¥åŠ[babel](https://babeljs.io/)è¿™ç§ ES6 è½¬ ES5 çš„å·¥å…·çš„æ…¢æ…¢æˆç†Ÿ, åœ¨çœŸå®äº§å“é‡Œä½¿ç”¨ ES6 å·²ç»å®Œå…¨å¯è¡Œäº†ã€‚

å†™ JS çš„æœ‹å‹ä»¬ï¼Œæ˜¯æ—¶å€™ç‚¹å¼€[es6features](https://github.com/lukehoban/es6features)çœ‹ä¸€ä¸‹äº†ã€‚

å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒES6 ç‰¹æ€§é‡Œç«Ÿç„¶åŒ…æ‹¬å°¾è°ƒç”¨ä¼˜åŒ–([tail call](https://en.wikipedia.org/wiki/Tail_call))ï¼ŒçœŸæ˜¯è¦ç‚¹ä¸ªèµ:thumbsup:ã€‚ç„¶è€Œï¼Œè¿™å¹¶æ²¡æœ‰ä»€ä¹ˆç”¨ã€‚

## ä» ES6 çš„ Generator è°ˆèµ·

åœ¨ ES6 ä¼—å¤šæ–°ç‰¹æ€§é‡Œï¼ŒGenerator æ— ç–‘æ˜¯ä¸€ä¸ªå¾ˆé…·çš„ä¸œè¥¿ã€‚cool åœ¨å“ªé‡Œï¼Ÿçœ‹ code:

```javascript
// æ³¨: ä»¥ä¸‹codeå¯ä»¥åœ¨chrome dev toolçš„consoleé‡Œç›´æ¥è·‘
function* fib() {
  // ç”¨function*æ¥å®šä¹‰generator
  var pre = 0,
    cur = 1;
  for (;;) {
    // æ— é™å¾ªç¯
    var temp = pre;
    pre = cur;
    cur += temp;
    var reset = yield cur; // yieldå†³å®šnext()çš„è¿”å›å€¼
    if (reset) {
      (pre = 0), (cur = 1);
    }
  }
}
var g = fib();
console.log(g.next().value); // 1
console.log(g.next().value); // 2
console.log(g.next().value); // 3
console.log(g.next().value); // 5
console.log(g.next(true).value); // 1
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª fibonacci æ•°åˆ—çš„ generator, æ¯æ¬¡è°ƒç”¨`next()`, ä¼š yield ä¸‹ä¸€ä¸ªæ•°å­—; è€Œ`next`çš„å‚æ•°åˆ™ä¼šæ˜¯ yield è¡¨è¾¾å¼çš„å€¼ï¼Œæ¯”å¦‚`next(true)`, åˆ™ `yield cur`å°±è¿”å› trueã€‚

å¯ä»¥çœ‹åˆ° code é‡Œæœ‰ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œä½†å¹¶ä¸ä¼šå¯¼è‡´ CPU hang ä½, å› ä¸ºæ¯ä¸€æ¬¡`yield`åï¼Œç¨‹åºä¼šæš‚åœï¼Œè€Œåœ¨`next()`ä¹‹ååˆç»§ç»­è¿è¡Œã€‚è€Œè¿™ï¼Œä¾¿æ˜¯ generator æœ€ cool çš„åœ°æ–¹ï¼š**å®ƒæ”¹å˜äº†ç¨‹åºçš„æ§åˆ¶æµ**ï¼

ç®€å•æ¥è¯´ï¼Œyield åœæ­¢ï¼Œnext ç»§ç»­ï¼Œäºæ˜¯é€šè¿‡è¿™ä¸ªè§„åˆ™ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ§åˆ¶ç¨‹åºçš„è¿è¡Œé¡ºåºã€‚äºæ˜¯æˆ‘ä»¬å¯ä»¥å†™å‡ºè¿™æ ·çš„ code:

```javascript
co(function* (){
  var data1 = yield ajax_call_1(); // å‘å‡ºä¸€ä¸ªajaxè¯·æ±‚
  console.log(data1); // è¾“å‡ºresponse
  var data2 = yield ajax_call_2(data1); // å‘å‡ºå¦ä¸€ä¸ªè¯·æ±‚
  console.log(data2); // è¾“å‡ºresponse
  var data3 = yield ajax_call_3(data2); // å‘å‡ºå¦ä¸€ä¸ªè¯·æ±‚
  console.log(data3); // è¾“å‡ºresponse
});

//----------------------------------

// ä»¥ä¸‹ä¸ºå¯¹æ¯”çš„callbackå†™æ³•
(function(){
  ajax_call_1(function(data1){
      console.log(data1);
      ajax_call_2(data1, function(data2){
          console.log(data2);
          ajax_call_3(data2, function(data3){
              console.log(data3);
              ...
          });
          ...
       });
    });
})();

```

è¿™æ®µçœ‹ä¼¼åŒæ­¥çš„ä»£ç å®é™…ä¸Šæ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œä½†æ˜¯ç›´è§‚ç®€å•æ¼‚äº®ï¼Œå†™èµ·æ¥å¯ä»¥è°ˆç¬‘é£ç”Ÿï¼Œæ¯” callback ä¸çŸ¥é“é«˜åˆ°å“ªå»äº†(å…³äºè¿™ä¸€ç‚¹ï¼Œå¯ä»¥çœ‹ tj å†™çš„[callbacks vs coroutines](https://medium.com/@tjholowaychuk/callbacks-vs-coroutines-174f1fe66127))ã€‚è‡³äºé‚£ä¸ª`co`ï¼Œå°±æ˜¯æŸä¸ªå¥‡æ€ªçš„å‡½æ•°ï¼Œåœ¨é€‚å½“çš„æ—¶å€™(æ¯”å¦‚ callback æ—¶)è°ƒä¸€ä¸‹`next`è®© generator ç»§ç»­è·‘ã€‚æ„Ÿå…´è¶£çš„è¯ï¼Œè¯·æˆ³[co](https://github.com/tj/co)

ç°åœ¨è®©æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ï¼š generator æ˜¯ä¸€ç§ç‰¹æ®Šçš„å­ç¨‹åºï¼Œè€Œ`yield`æ˜¯ä¸€ç§`æµç¨‹æ§åˆ¶`æŒ‡ä»¤ï¼Œåœ¨ generator é‡Œä½¿ç”¨ yield ä¼šå°†ç¨‹åºçš„`æ§åˆ¶æƒ`äº¤è¿˜ç»™è°ƒç”¨è€…(å³è¿”å›è°ƒç”¨å¤„)ï¼Œè€Œå¤–ç•Œè°ƒç”¨ generator çš„`next`æ–¹æ³•ä¼šè®©è¯¥ generator`ç»§ç»­`æ‰§è¡Œã€‚generator å¯ä»¥ç”¨æ¥åš[iterator](https://en.wikipedia.org/wiki/iterator)ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥ç©é­”æ³•(åŒæ­¥è½¬å¼‚æ­¥)ï¼Œå› ä¸ºå®ƒæä¾›äº†ä¸€ç§è¾ƒä¸ºä¼˜é›…çš„æµç¨‹æ§åˆ¶æ–¹å¼

ä¸è¿‡ï¼Œè¯´æ˜¯ magicï¼Œä½†å…¶å®ç¨‹åºçš„ä¸–ç•Œï¼Œå¹¶æ²¡æœ‰æ— æ ¹ä¹‹æœ¨ã€æ— æºä¹‹æ°´ã€‚æ¥ä¸‹æ¥ï¼Œå°±è®©æˆ‘ä»¬å›æº¯æœ¬æºï¼Œæ¢ä¸€æ¢å„ç§æµç¨‹æ§åˆ¶ç»“æ„çš„æ¥é¾™å»è„‰

## å…³äºæ§åˆ¶æµ(control flow)

æ‰€è°“æ§åˆ¶æµï¼Œè¯´ç™½äº†å°±æ˜¯ç¨‹åºæ‰§è¡Œçš„é¡ºåºã€‚

æˆ‘ä»¬çŸ¥é“ï¼Œç¨‹åºæ‰§è¡Œçš„åŸºæœ¬åŸç†æ˜¯ï¼šcpu ä» program counter(ä¸€ä¸ªå¯„å­˜å™¨)æ‹¿æŒ‡ä»¤çš„å†…å­˜åœ°å€ï¼Œç„¶åå»å†…å­˜æ‹¿æŒ‡ä»¤æ¥æ‰§è¡Œï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šæ”¹å˜ program counter çš„å€¼(æ¯”å¦‚åŠ  1ï¼Œä¹Ÿå°±æ˜¯é¡ºåºæ‰§è¡Œ)ã€‚å¦‚æ­¤å¾ªç¯å¾€å¤ç›´è‡³ç»“æŸã€‚

ç¨‹åºæµç¨‹çš„æ§åˆ¶ï¼Œå®é™…ä¸Šå°±æ˜¯åœ¨ç‰¹å®šçš„æƒ…å†µä¸‹ï¼Œæ›´æ–°ç‰¹å®šçš„å€¼åˆ° program counterã€‚è€Œä¸Šå‡åˆ°ç¼–ç¨‹çš„å±‚æ¬¡ï¼Œåˆ™æ˜¯æä¾›ä»£è¡¨ç‰¹å®šç­–ç•¥çš„æµç¨‹æ§åˆ¶è¯­å¥ï¼Œç”¨ä»¥å®ç°å„ç§ä¸°å¯Œçš„åŠŸèƒ½ã€‚

ä¸€èˆ¬è€Œè¨€ï¼Œæµç¨‹æ§åˆ¶è¯­å¥å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š

- æ— æ¡ä»¶åˆ†æ”¯

  å°±æ˜¯ goto äº†ï¼Œæƒ³å»å“ªå»å“ª(å½“ç„¶è¿˜æ˜¯æœ‰é™åˆ¶çš„ï¼Œæ¯”å¦‚ c è¯­è¨€é‡Œ goto å°±ä¸èƒ½è·³å‡ºå½“å‰ function)ã€‚å…¶ç¼ºç‚¹åœ¨äºï¼Œç¨‹åºå¯è¯»æ€§/å¯ç»´æŠ¤æ€§å®¹æ˜“å˜å¾—æå·®ã€‚

- æ¡ä»¶åˆ†æ”¯

  è¿™ä¸ªå…¶å®å°±æ˜¯å¤§å®¶è€³ç†Ÿèƒ½è¯¦çš„å„ç§åŸºæœ¬æµç¨‹æ§åˆ¶è¯­å¥äº†ï¼Œæ¯”å¦‚ if-else, switch, ä»¥åŠ for, while ç­‰ loop è¯­å¥

- æ— æ¡ä»¶ç»ˆæ­¢ç¨‹åº

  æ¯”å¦‚ exit, return

- è¿è¡Œä½åœ¨`ä¸åŒä½ç½®`çš„ä¸€æ®µæŒ‡ä»¤ï¼Œä½†å®Œæˆåä¼š`ç»§ç»­`è¿è¡ŒåŸæ¥è¦è¿è¡Œçš„æŒ‡ä»¤

  åŒ…æ‹¬å­ç¨‹åº(subroutine)ã€åç¨‹ï¼ˆcoroutineï¼‰åŠå»¶ç»­æ€§ï¼ˆcontinuationï¼‰ã€‚(æ³¨ï¼šgenerator å®é™…ä¸Šæ˜¯ä¸€ç§ coroutine)

å‰ä¸‰ç§æ¯”è¾ƒç›´ç™½ç®€å•ï¼Œä¹Ÿæ¯”è¾ƒå¸¸è§ï¼Œæˆ‘ä»¬ä¸»è¦çœ‹ç¬¬å››ç§ã€‚

**è¿è¡Œå¦ä¸€æ®µæŒ‡ä»¤ï¼Œç„¶åè¿”å›åŸæŒ‡ä»¤æ®µä¸­ç»§ç»­æ‰§è¡Œ**ã€‚è¿™ç§æƒ…å†µæœ€å¸¸è§çš„å°±æ˜¯ subroutine(æ¯”å¦‚ function æˆ–è€… OO è¯­è¨€é‡Œçš„ method)äº†ï¼Œä¸€èˆ¬éƒ½æ˜¯é€šè¿‡`call stack`æ¥å®ç°ï¼Œæ¯æ¬¡ function call éƒ½äº§ç”Ÿä¸€ä¸ª stack frame å‹å…¥æ ˆé¡¶ï¼Œè¯¥ function ç»“æŸæ—¶å°†å…¶å‡ºæ ˆï¼Œè¿™æ ·æ ˆé¡¶å°±å˜å›å…¶ caller çš„ stack frame äº†ï¼Œäºæ˜¯å¯ä»¥ç»§ç»­æ‰§è¡Œ caller çš„ä»£ç ã€‚

æˆ‘ä»¬çœ‹ä¸€ä¸‹å…¸å‹çš„ subroutine è°ƒç”¨:

```javascript
function doOtherthing() {
  // block B
  {
    console.log("executing...doOtherthing");
    return;
  }
}

function doSomething() {
  // block A
  {
    console.log("executing...doSomething");
  }

  doOtherthing();

  // block C
  {
    console.log("continue executing...doSomething");
    return;
  }
}

doSomething();
// executing...doSomething
// executing...doOtherthing
// continue executing...doSomething
```

è¿™é‡Œæ²¡ä»€ä¹ˆå¥‡æ€ªçš„ä¸œè¥¿ï¼Œåˆ†æˆå‡ ä¸ª block åªæ˜¯ä¸ºäº†æ–¹ä¾¿å¼•ç”¨ï¼Œç›¸ä¿¡å­¦è¿‡å‡ å¤©ç¼–ç¨‹çš„éƒ½èƒ½ç†è§£ã€‚

ç°åœ¨æˆ‘ä»¬ä»æ§åˆ¶æµçš„è§’åº¦åˆ†æä¸€ä¸‹è¿™ä¸ªç¨‹åºã€‚block B æ˜æ˜¾ä¸ A å’Œ C ä¸åœ¨ä¸€å¤„ï¼Œä½†æ‰§è¡Œé¡ºåºå´æ˜¯ A=>B=>Cã€‚A æ‰§è¡Œåæ˜¯ subroutine è°ƒç”¨ï¼Œjump åˆ° B å¤„æ‰§è¡Œï¼›è€Œ B æ‰§è¡Œåä¼šè¿”å›åˆ° C å¤„æ‰§è¡Œï¼Œè¿™ä¹Ÿæ­£æ˜¯ return è¯­å¥çš„è¯­ä¹‰ã€‚

subroutine è°ƒç”¨çš„æ‰§è¡Œé¡ºåºæ˜¯å›ºå®šçš„ï¼Œè¿™æ˜¯å› ä¸º return æ˜¯ä¸€ä¸ªå…³é”®å­—ï¼Œæä¾›éšå¼çš„æµç¨‹æ§åˆ¶ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½åƒæ“ä½œä¸€ä¸ª object ä¸€æ ·æ¥æ“ä½œå®ƒâ€”â€”ç­‰ç­‰ï¼Œå¦‚æœå¯ä»¥å‘¢ï¼Ÿ

å¦‚æœ return çš„è¯­ä¹‰å¯ä»¥è¢«æŠ½è±¡å‡ºæ¥å¹¶èƒ½åœ¨ç¨‹åºä¸­æ“ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†å¯ä»¥ä¿å­˜ä»»æ„çš„æ‰§è¡Œç‚¹ï¼Œå¹¶ä¸”åœ¨ä»»æ„æ—¶å€™è¿”å›è¯¥å¤„ç»§ç»­æ‰§è¡Œã€‚è¿™å¥è¯çš„æ„æ€æ˜¯ï¼Œæˆ‘ä»¬çš„ç¨‹åºå°†å¯ä»¥å®ç°ä»»æ„çš„æ§åˆ¶æµï¼Œè€Œæ— éœ€è¿è¡Œç¯å¢ƒçš„æ”¯æŒï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬å¯ä»¥åœ¨ ES5 é‡Œå®ç° generatorã€‚

ä½ æˆ–è®¸å·²ç»å¬è¿‡è¿™ç§æŠ½è±¡çš„åå­—ï¼šcontinuation

## Continuation

åœ¨è®¡ç®—æœºç§‘å­¦é‡Œï¼ŒContinuation æ˜¯æŒ‡å¯ä»¥è¢«ç¼–ç¨‹è¯­è¨€è®¿é—®çš„ã€å¯¹**ç¨‹åºæ§åˆ¶æµç¨‹/çŠ¶æ€**çš„æŠ½è±¡è¡¨ç¤ºã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ç¨‹åº`è¿è¡Œæ—¶`çš„æŸä¸ªæ‰§è¡Œç‚¹ï¼Œæ¯”å¦‚ä¸Šæ–‡æ‰€è¯´çš„ block B é‡Œçš„ return è¿è¡Œåçš„é‚£ä¸ªç‚¹ã€‚è€Œ return è¯­å¥å¯ä»¥ç†è§£ä¸ºéšå¼çš„è°ƒç”¨äº† current continuationã€‚

æˆ‘ä»¬è¯´`current continuation`, æ˜¯æŒ‡åœ¨é‚£ä¸ªç‚¹ä¹‹åå°†è¦æ‰§è¡Œçš„ä»£ç ï¼Œæ¯”å¦‚ B return æ—¶ï¼Œcurrent continuation å°±æ˜¯æ•´ä¸ª block Cã€‚

è¯´åˆ° continuationï¼Œå°±ä¸å¾—ä¸è¯´ CPS(continuation passing style)ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯æ˜¾å¼çš„å°† continuation ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œä»¥æ­¤æ¥è¿›è¡Œæµç¨‹æ§åˆ¶ã€‚è€Œæˆ‘ä»¬å¹³å¸¸å†™çš„ code å«åš direct styleï¼Œæ¯”å¦‚ä¸Šæ–‡ doSomething é‚£æ®µ codeã€‚

æˆ‘ä»¬ç°åœ¨å°†ä¹‹å‰çš„ code æ”¹å†™æˆ CPS:

```javascript
function doOtherthing(k) {
  // block B
  {
    console.log("executing...doOtherthing");
    k();
  }
}

function doSomething(k) {
  // block A
  {
    console.log("executing...doSomething");
  }

  doOtherthing(function (ret) {
    // block C
    {
      console.log("continue executing...doSomething");
      k();
    }
  });
}

doSomething(function () {});
// executing...doSomething
// executing...doOtherthing
// continue executing...doSomething
```

æ”¹å†™åæ‰§è¡Œç»“æœæ˜¯ä¸€æ ·çš„ã€‚å¯ä»¥çœ‹åˆ°å‡½æ•°è°ƒç”¨å˜æˆäº† callback çš„å½¢å¼ï¼Œè€Œ return éƒ½å˜æˆäº†`k()`ï¼Œè¿™ä¸ª k å°±æ˜¯ä¼ å…¥çš„ continuationã€‚

æ³¨æ„ï¼Œè¿™é‡Œçš„é‡ç‚¹å¹¶ä¸åœ¨äº callback å½¢å¼ï¼Œè€Œåœ¨äº**CPS å˜æ¢**ï¼Œä¹‹å‰çš„ code å’Œè¿™æ®µ code æ˜¯ç­‰ä»·çš„ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬æ˜¯æ‰‹åŠ¨åšçš„ CPS å˜æ¢ï¼Œä½†å®é™…ä¸Šï¼Œæ‰€æœ‰ direct style çš„ code éƒ½å¯ä»¥è¢«`è‡ªåŠ¨`å˜æ¢æˆ CPS çš„ codeã€‚(è‡³äºæ€ä¹ˆå˜æ¢ï¼Œå¯ä»¥å°è¯•çœ‹[How to compile with continuations](http://matt.might.net/articles/cps-conversion/))

ä¸ºä½•è¦å¼ºè°ƒè‡ªåŠ¨çš„ CPS å˜æ¢ï¼Ÿå› ä¸ºå®ƒå¯ä»¥ç”¨æ¥å®ç°ä¸€ä¸ªé”‹åˆ©æ— åŒ¹çš„å¼ºå¤§å‡½æ•°: `call/cc`

## call/cc

scheme è¯­è¨€é‡Œæœ‰ä¸€ä¸ªè‘—åçš„å‡½æ•°ï¼Œå«åš call-with-current-continuation, ä¸€èˆ¬ç®€ç§°ä¸º call/ccã€‚

call/cc æ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œå¹¶æ•æ‰ current continuation ç„¶åå°†ä¹‹ä¼ é€’ç»™è¿™ä¸ªå‡½æ•°ã€‚è€Œ continuation ä¸€è¢«è°ƒç”¨ï¼Œcall/cc**ç«‹å³**è¿”å›ï¼Œè¿”å›å€¼å³ä¸ºä¼ ç»™ continuation çš„å‚æ•°ã€‚
æ¯”å¦‚ï¼š

```scheme
(let ((a (call/cc
          (lambda (k)
            (begin
              (display "will execute\n") ; è¾“å‡º "will execute\n"
              (k 1)
              (display "will not execute")))))) ; ä¸æ‰§è¡Œ
  (display a)) ; è¾“å‡º1
```

å†æ¥æ®µ JS çš„ç‰ˆæœ¬ï¼ŒJS é‡Œå½“ç„¶æ˜¯æ²¡æœ‰ call/cc çš„äº†ï¼Œä¸è¿‡è¿™ä¸å¦¨ç¢æˆ‘ç”¨ JS æ¥è¡¨è¾¾ã€‚æ­¤å¤„å‡è®¾ js é‡Œæœ‰ä¸€ä¸ªç­‰ä»·çš„ callccï¼š

```javascript
var a = callcc(function (k) {
  console.log("will execute"); // è¾“å‡º "will execute"
  k(1);
  console.log("will not execute"); // ä¸ä¼šæ‰§è¡Œ
});

console.log(a); // è¾“å‡º1
```

è¿™æ®µ code ç­‰åŒäº:

```javascript
(function (k) {
  console.log("will execute"); // è¾“å‡º "will execute"
  k(1);
})(function (a) {
  console.log(a);
});
```

è¿™å®è´¨ä¸Šå°±æ˜¯è‡ªåŠ¨åšäº† CPS å˜æ¢ã€‚

æœ‰äº† call/ccï¼Œå°±å¯ä»¥ç›´æ¥åœ¨ç¨‹åºé‡Œæ“ä½œ continuation äº†ã€‚ä»…ä»åŠŸèƒ½ä¸Šæ¥è¯´ï¼Œå°±å¯ä»¥å®ç°å„ç§é«˜çº§æ§åˆ¶æµï¼Œè€Œä¸éœ€è¦ç¼–è¯‘å™¨/è§£é‡Šå™¨è¿™ä¸ª level çš„æ”¯æŒäº†ã€‚

æ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬çœ‹çœ‹ call/cc çš„ power

## Coroutine

Coroutine(åç¨‹)æ˜¯ä¸€ç§ç±»ä¼¼ subroutine ä½†æ›´çµæ´»çš„æ§åˆ¶ç»“æ„ï¼Œå®ƒå…è®¸æœ‰å¤šä¸ª**ç¨‹åºè¿›å…¥ç‚¹**ï¼Œå¯ä»¥éšæ„`æš‚åœ`æˆ–`ç»§ç»­`æ‰§è¡Œï¼Œä¸»è¦ç”¨æ¥åš nonpreemptive multitasking(éæŠ¢å å¼å¤šä»»åŠ¡å¤„ç†)ã€‚

åœ¨ coroutine ä¸­ï¼Œå¯ä»¥é€šè¿‡`yield`è¯­å¥æ¥è½¬ç§»æ§åˆ¶æƒï¼Œæ¯”å¦‚ä¸¤ä¸ª coroutineï¼Œc1 å’Œ c2ï¼Œåœ¨ c1 ä¸­è°ƒç”¨`yield to c2`(ä¼ªä»£ç ), å°±ä¼šå»æ‰§è¡Œ c2ï¼Œåœ¨ c2 ä¸­åˆè°ƒç”¨`yield to c1`ï¼Œå°±ä¼š`ç»§ç»­`æ‰§è¡Œ c1(é‡æ–°è¿›å…¥ä¹‹å‰çš„æ‰§è¡Œç‚¹)ã€‚å¬èµ·æ¥å’Œä¹‹å‰è¯´çš„ generator æœ‰äº›åƒï¼Ÿå…¶å® generator å°±æ˜¯ä¸€ç§ coroutineï¼Œæˆ‘ä»¬ä¹‹åä¼šè®²åˆ°ã€‚

[Donald Knuth](https://en.wikipedia.org/wiki/Donald_Knuth)è¯´ï¼š"subroutine æ˜¯ coroutine çš„ç‰¹ä¾‹"ï¼Œå› ä¸º subroutine å¯ä»¥çœ‹ä½œä¸ä½¿ç”¨`yield`çš„ coroutineã€‚

æˆ‘ä»¬è¯´ coroutine æ˜¯ç”¨æ¥åš nonpreemptive multitasking(éæŠ¢å å¼å¤šä»»åŠ¡å¤„ç†)çš„ï¼Œè¦ç†è§£è¿™ä¸€ç‚¹ï¼Œæœ€å¥½å…ˆç†è§£ preemptive multitasking(æŠ¢å å¼å¤šä»»åŠ¡å¤„ç†)ã€‚

æˆ‘ä»¬ç†ŸçŸ¥çš„åŸºäºå¤šçº¿ç¨‹çš„å¤šä»»åŠ¡/å¹¶å‘å¤„ç†å°±æ˜¯ preemptive çš„, ç¨‹åºæ§åˆ¶æƒç”±**è°ƒåº¦å™¨**è€Œéç¨‹åºè‡ªèº«æ¥å†³å®šï¼Œ å®è´¨ä¸Šå°±æ˜¯åœ¨ç¨‹åº`å¤–éƒ¨`**å¼ºè¡Œ**æ‰“æ–­ç¨‹åºçš„è¿è¡Œï¼Œå†æ ¹æ®æŸç§ç­–ç•¥(ä¼˜å…ˆçº§,åŠ¨æ€æ—¶é—´ç‰‡)å†³å®šç”±å“ªä¸ªçº¿ç¨‹ç»§ç»­æ‰§è¡Œã€‚

è€Œ coroutine æ˜¯è‡ªå·²å†³å®šå°†æ§åˆ¶æƒäº¤ç»™è°(yield)ï¼Œå› è€Œä¸ä¼šæœ‰ race condition, ä¸éœ€è¦è€ƒè™‘é”çš„é—®é¢˜ï¼Œå¯ä»¥æå¤§çš„ç®€åŒ–å¹¶å‘ç¼–ç¨‹ã€‚

è¿™é‡Œè¦æä¸€ä¸‹ä¸ºä½•æˆ‘ä»¬ç†ŸçŸ¥çš„æ˜¯æŠ¢å å¼å¤šä»»åŠ¡å¤„ç†ï¼Œå› ä¸ºäººä»¬éœ€è¦æµç•…çš„åŒæ—¶åšå¤šä»¶(ä¸ç›¸å…³çš„)äº‹çš„èƒ½åŠ›ï¼Œæ¯”å¦‚åœ¨ä¸Šç½‘æ—¶ä¸‹è½½å’Œå¬éŸ³ä¹ï¼Œè€ŒæŠ¢å å¼çš„å¤šä»»åŠ¡å¤„ç†æœ‰åŠ©äºå®ç°è¿™ä¸€ç‚¹(ä¸ä¼šå› ä¸ºæ§åˆ¶æƒè¢«å ç”¨è€Œå¯¼è‡´å…¶å®ƒåº”ç”¨ hang ä½)ã€‚è€Œç¼–ç¨‹æ—¶å…³æ³¨çš„æ˜¯å¦‚ä½•æ›´é«˜æ•ˆçš„åšå¥½äº‹æƒ…ï¼Œå¹¶ä¸”å¼€å‘è€…çŸ¥æ™“å…¨éƒ¨çš„ contextï¼Œä¹Ÿå°±å®¹æ˜“æ˜ç™½å¦‚ä½•å»åè°ƒæ§åˆ¶æƒï¼Œæ‰€ä»¥ä»ç¼–ç¨‹çš„è§’åº¦ï¼ŒéæŠ¢å å¼å¤šä»»åŠ¡å¤„ç†åè€Œæ›´æœ‰ä¼˜åŠ¿ã€‚

è€Œä»å…·ä½“å®ç°çš„è§’åº¦æ¥çœ‹ï¼Œcoroutine ä¸€èˆ¬æ˜¯è¯­è¨€çº§åˆ«çš„å®ç°ï¼Œå®é™…ä¸Šæ˜¯åœ¨ç”¨æˆ·æ€è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä¸ä¼šé™·å…¥å†…æ ¸æ€ï¼Œå› è€Œæ›´é«˜æ•ˆã€‚

coroutine çš„ç¼ºç‚¹æ˜¯æ— æ³•åˆ©ç”¨å¤šæ ¸ï¼Œå®ƒåªèƒ½åš concurrencyï¼Œè€Œä¸èƒ½åš parallelismï¼Œå› ä¸ºä¸€èˆ¬å®ƒæ˜¯è·‘åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šï¼Œå¤šä¸ª coroutine ä¸èƒ½åŒæ—¶è¿è¡Œã€‚ä½†æ˜¯ä¹Ÿæœ‰æ”¹è¿›çš„æ–¹æ¡ˆï¼Œæ¯”å¦‚ go è¯­è¨€çš„ goroutine, å°±æ˜¯ work åœ¨ä¸€ä¸ªçº¿ç¨‹æ± ä¹‹ä¸Šçš„ï¼Œä¸è¿‡è¿™æ ·å°±éœ€è¦æ›´å¤æ‚çš„è°ƒåº¦äº†ï¼Œå½“ç„¶åå­—ä¹Ÿåä¸½çš„å˜äº†ã€‚

ä»¥ä¸‹æ˜¯ç”¨ callcc å®ç°ç®€å•çš„åç¨‹(ä¸è¿‡ä¸èƒ½è¿è¡Œ):

```javascript
var queue = [];
function isEmpty() {
  return queue.length == 0;
}
function enqueue(x) {
  queue.push(x);
}
function dequeue() {
  return queue.shift();
}
function run(f) {
  callcc(function (k) {
    enqueue(k); // å°†current continuation enqueue
    f();
  });
}
function $yield() {
  callcc(function (k) {
    enqueue(k);
    dequeue()(); // dequeueæŸä¸ªcontinuationå¹¶æ‰§è¡Œ
  });
}

function doSomething(str) {
  for (;;) {
    console.log(str);
    $yield(); // æ”¾å¼ƒæ§åˆ¶æƒ
    // point C
  }
}

run(function () {
  doSomething("A");
});

// point A
run(function () {
  doSomething("B");
});

// point B
if (!isEmpty) {
  dequeue()();
}

// ç†è®ºä¸Šçš„è¾“å‡ºç»“æœä¸º
// A
// B
// A
// B
// ..., Aå’ŒBäº¤æ›¿è¾“å‡º
```

ç®€å•æè¿°ä¸€ä¸‹ç¨‹åºçš„æ‰§è¡Œï¼š

1. æ‰§è¡Œç¬¬ä¸€ä¸ª run
   - continuation æŒ‡å‘ point Aï¼Œç„¶åå®ƒè¢« enqueue, æ­¤æ—¶ queue ä¸º[A]
2. æ‰§è¡Œ doSomething("A")
   - è¾“å‡º A
   - æ‰§è¡Œ`$yield()`
     - å°†å½“å‰ continuation enqueue, æ­¤æ—¶ queue ä¸º[A, C-A]
     - dequeue å¹¶æ‰§è¡Œï¼Œæ­¤æ—¶ queue ä¸º[C-A], ä» point A å¤„æ‰§è¡Œ
3. point A, æ‰§è¡Œç¬¬äºŒä¸ª run
   - continuation æŒ‡å‘ point B, ç„¶åå®ƒè¢« enqueueï¼Œæ­¤æ—¶ queue ä¸º[C-A, B]
4. æ‰§è¡Œ doSomething("B")
   - è¾“å‡º B
   - æ‰§è¡Œ`$yield()`
     - å°†å½“å‰ continuation enqueue, æ­¤æ—¶ queue ä¸º[C-A, B, C-B]
     - dequeue å¹¶æ‰§è¡Œï¼Œæ­¤æ—¶ queue ä¸º[B, C-B], ä» C-A å¤„æ‰§è¡Œ
5. C-A å¤„
   - è¾“å‡º A
   - æ‰§è¡Œ`$yield()`
     - enqueue, queue ä¸º[B, C-B, C-A]
     - dequeue å¹¶æ‰§è¡Œï¼Œæ­¤æ—¶ queue ä¸º[C-B, C-A], ä» B å¤„æ‰§è¡Œ
6. B å¤„ï¼Œdequeue å¹¶æ‰§è¡Œï¼Œä» C-B å¤„æ‰§è¡Œï¼Œè¾“å‡º Bï¼Œå¹¶ enqueue, æ­¤æ—¶ queue ä¸º[C-A, C-B]
7. [C-A, C-B] -> [C-B, C-A] -> [C-A, C-B] å¾ªç¯, A å’Œ B äº¤æ›¿è¾“å‡º

å¯è§é€šè¿‡`callcc`å’Œä¸€ä¸ª queueï¼Œæˆ‘ä»¬å¯ä»¥è½»æ˜“çš„å®ç° coroutine

## Generator

Generator åˆå« Semi-Coroutine(åŠåç¨‹)æˆ– Asymmetric Coroutine(ä¸å¯¹ç§°åç¨‹)ï¼Œå®ƒæœ¬è´¨ä¸Šä»æ˜¯åç¨‹ï¼Œå’Œä¸€èˆ¬çš„åç¨‹çš„åŒºåˆ«åœ¨äºï¼Œgenerator åªèƒ½æŠŠæ§åˆ¶æƒäº¤è¿˜ç»™å®ƒçš„`caller`, è€Œ coroutine æ˜¯å¯ä»¥å†³å®šæŠŠæ§åˆ¶æƒäº¤ç»™è°ã€‚

å…ˆçœ‹ä¸€ä¸ª callcc å®ç°çš„ generator:

```javascript
function fib() {
  var controlState = function ($yield) {
    var pree = 0;
    var pre = 1;
    while (true) {
      callcc(function (resume) {
        controlState = resume;
        $yield(pree);
      });
      var tmp = pree;
      pree = pre;
      pre = tmp + pre;
    }
  };

  return {
    next: function () {
      return callcc(controlState);
    },
  };
}
```

`next`è°ƒç”¨æ—¶ï¼Œè¿›å…¥ controlState å‡½æ•°ï¼Œ$yield ä¸€æ—¦è°ƒç”¨ï¼Œé©¬ä¸Šè¿”å›ï¼Œä½†æ˜¯ controlState å·²ç»è¢«æ›¿æ¢æˆå†…éƒ¨å¾ªç¯å¤„çš„ continuationï¼Œå› è€Œå½“`next`å†è°ƒç”¨æ—¶ä¼šå›åˆ°å¾ªç¯å¤„ç»§ç»­æ‰§è¡Œã€‚

å…¶å® generator å¯ä»¥å’Œ coroutine äº’ç›¸è½¬åŒ–ï¼Œå› ä¸ºå®ƒä»¬æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„ä¸œè¥¿ã€‚generator åŠ ä¸€ä¸ª scheduler å°±å¯ä»¥å®ç° coroutine(yield ä¸€ä¸ª value, ç„¶åæ ¹æ® value å†³å®š resume å“ªä¸ª generator)

æ¥ä¸€ä¸ªç”¨ ES6 generator æ¨¡æ‹Ÿ couroutine çš„ä¾‹å­(å¯ä»¥åœ¨ chrome dev tool é‡Œè¿è¡Œ):

```javascript
function* ge1() {
  for (var i = 1; ; i++) {
    console.log("running...generator 1, " + i + " times");
    yield "g2";
  }
}

function* ge2() {
  for (var i = 1; ; i++) {
    console.log("running...generator 2, " + i + " times");
    yield "g1";
  }
}

function schedule() {
  var map = {
    g1: ge1(),
    g2: ge2(),
  };
  var current = "g1";
  for (var i = 0; i < 100; i++) {
    current = map[current].next().value; // current åœ¨'g1'å’Œ'g2'é—´æ¥å›å˜åŒ–
  }
}

schedule();
```

## Delimited Continuation

å…³äº continuation, è¿˜æœ‰ä¸€ä¸ªå€¼å¾—ä¸€æçš„æ˜¯ Delimited Continuationï¼ŒScala é‡Œå°±æ”¯æŒè¿™ç§ continuationã€‚å®ƒæ˜¯åœ¨ä¸€ä¸ªé™å®šçš„åŒºåŸŸé‡Œï¼Œæ•æ‰ continuation å¹¶å…·ä½“åŒ–æˆä¸€ä¸ªå‡½æ•°ï¼Œä»¥ä¾›å¤ç”¨ã€‚ä¸€èˆ¬æ˜¯é€šè¿‡ reset+shift æ¥è¡¨è¾¾ï¼š

```scheme
(reset
 (display (* 2 (shift k
                      (k 2)
                      (k 4)
                      (k 3)))))
```

ç”¨ JS æ¥ç¿»è¯‘ä¸€ä¸‹ï¼š

```javascript
reset(function () {
  var x = shift(function (k) {
    k(2);
    k(4);
    k(3);
  });
  console.log(2 * x);
});
// 4
// 8
// 6
```

å†ç¿»è¯‘æˆ CPSï¼š

```javascript
(function (k) {
  k(2);
  k(4);
  k(3);
})(function (x) {
  console.log(2 * x);
});
```

ç°åœ¨åº”è¯¥å¾ˆå¥½ç†è§£äº†ï¼Œç±»ä¼¼äº call/cc çš„æƒ…å†µï¼Œä¸è¿‡ç”¨ reset é™å®šäº†ä¸€ä¸ª scopeã€‚ å°† shift ä¹‹å**reset ä¹‹å†…**çš„ä»£ç æ•æ‰å¹¶å°è£…æˆä¸€ä¸ªå‡½æ•°ï¼Œç„¶åä¼ é€’ç»™ shift å—é‡Œçš„é‚£ä¸ªå‡½æ•°ã€‚

è¿™é‡Œä¸€ä¸ªè¦æ³¨æ„çš„ç‚¹æ˜¯ï¼Œshift é‡Œçš„`k`æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥å®ƒå¯ä»¥å¤šæ¬¡ä½¿ç”¨ï¼›è€Œ call/cc é‡Œçš„`k`è°ƒç”¨ä¸€æ¬¡å°±é€€å‡ºäº†ï¼Œåè¾¹çš„éƒ½ä¼š ignoreã€‚
ä»è¿™ä¸ªè§’åº¦è€Œè¨€ï¼Œdelimited continuation æ˜¯çº¯ç²¹çš„å‡½æ•°ï¼Œè€Œ undelimited continuation ä¸æ˜¯ï¼Œå› è€Œ delimited continuation æ›´ç›´è§‚æ›´ç¬¦åˆç›´è§‰ï¼Œä¹Ÿå°±æ›´é€‚åˆæˆ‘ä»¬ç”¨æ¥ç¼–ç¨‹

## æœ€å

ç¢äºèƒ½åŠ›ä»¥åŠç¯‡å¹…ï¼Œæœ¬æ–‡ä»…æ˜¯å¯¹ç¨‹åºæ§åˆ¶æµçš„æµ…å°è¾„æ­¢ã€‚

çºµè§‚è€Œè¨€ï¼Œå„ç§é«˜é˜¶çš„æµç¨‹æ§åˆ¶ç»“æ„ï¼Œéƒ½ä¸ continuation ç›¸å…³ï¼Œè¿™æ˜¯å› ä¸º continuation æ˜¯å¯¹(éšå¼çš„)æ§åˆ¶æµæœ¬èº«çš„æŠ½è±¡ã€‚

ä¸è¿‡ç°ä»£çš„é«˜çº§è¯­è¨€é‡Œï¼Œä¸€èˆ¬ä¸ç›´æ¥æä¾› first-class çš„ continuation, è€Œæ˜¯æä¾›å¦‚ generator, coroutine ç”šè‡³ delimited continuation ç­‰çš„é«˜é˜¶æ§åˆ¶ç»“æ„ï¼Œå› ä¸ºå®ƒä»¬è¶³å¤Ÿå¼ºå¤§è€Œåˆç›¸å¯¹ call/cc æ›´å¯æ§æ›´æ˜“äºç†è§£ã€‚

è€Œå®ƒä»¬çš„å®ç°ä¹Ÿä¸ä¼šæ˜¯åƒæˆ‘è¿™é‡Œæ‰€å†™çš„é‚£æ ·ç®€å•ï¼Œç”šè‡³ä¹Ÿä¸ä¸€å®šæ˜¯åŸºäº call/cc å»å®ç°ï¼Œç„¶è€Œå…¶åŸºæœ¬åŸç†æ˜¯ä¸€è‡´çš„ã€‚å› æ­¤ç†è§£ continuation, ç†è§£ CPSï¼Œç†è§£ call/ccï¼Œå°†æœ‰åŠ©äºæ›´å¥½çš„ç©è½¬å„ç§æµç¨‹æ§åˆ¶ã€‚
